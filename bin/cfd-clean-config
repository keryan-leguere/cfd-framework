#!/usr/bin/env bash
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#  cfd-clean-config â€” Clean les runs d'une configuration
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
#  Ce script permet de supprimer tous les runs d'une configuration, Ã  partir
#  du prefix usuel nom_version_nom_cas_timestamp.
#
#  Usage: cfd-clean-config [OPTIONS]
#
#  Auteur : KL
#  Licence : MIT
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

set -uo pipefail
IFS=$'\n\t'

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#  ğŸ”§ RÃ‰SOLUTION DE CFD_FRAMEWORK
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# RÃ©soudre CFD_FRAMEWORK si non dÃ©fini
if [[ -z "${CFD_FRAMEWORK:-}" ]]; then
  # Essayer depuis le chemin du script
  SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
  CFD_FRAMEWORK="$(cd "${SCRIPT_DIR}/.." && pwd)"
  
  export CFD_FRAMEWORK
fi

# VÃ©rifier que CFD_FRAMEWORK existe
if [[ ! -d "$CFD_FRAMEWORK" ]]; then
  echo "ERREUR: RÃ©pertoire CFD_FRAMEWORK introuvable: $CFD_FRAMEWORK" >&2
  exit 1
fi

source "${CFD_FRAMEWORK}/lib/format.sh"
source "${CFD_FRAMEWORK}/lib/utils.sh"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#  â“ FONCTION D'AIDE
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

usage() {
  echo ""
  echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
  echo "â•‘              ğŸ§¹ cfd-clean-config â€” Nettoyage des runs CFD                     â•‘"
  echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  echo ""
  printf "%bUSAGE:%b\n" "$BOLD" "$RESET"
  echo "  $0 [OPTIONS] <SOURCE_DIRECTORY>"
  echo "  cfd-clean-config [OPTIONS] <SOURCE_DIRECTORY>"
  echo ""
  printf "%bDESCRIPTION:%b\n" "$BOLD" "$RESET"
  echo "  Supprime tous les runs d'une configuration, identifiÃ©s par le prÃ©fixe"
  echo "  standard: \${ADAPTATEUR}_V\${VERSION}_\${CASE_NAME}_\${TIMESTAMP}"
  echo ""
  printf "%bARGUMENTS:%b\n" "$BOLD" "$RESET"
  echo "  SOURCE_DIRECTORY        RÃ©pertoire contenant les runs Ã  supprimer"
  echo ""
  printf "%bOPTIONS:%b\n" "$BOLD" "$RESET"
  echo "  -h, --help              Afficher cette aide"
  echo "  -f, --force             Supprimer sans confirmation"
  echo ""
  printf "%bVARIABLES D'ENVIRONNEMENT:%b\n" "$BOLD" "$RESET"
  echo "  CFD_FRAMEWORK           Chemin vers le framework CFD"
  echo "  ADAPTATEUR              Adaptateur utilisÃ© (dÃ©faut: OF)"
  echo ""
  printf "%bEXEMPLES:%b\n" "$BOLD" "$RESET"
  echo "  # Nettoyer tous les runs dans 02_PARAMS/BASELINE"
  echo "  cfd-clean-config 02_PARAMS/BASELINE"
  echo ""
  echo "  # Mode force (sans confirmation)"
  echo "  cfd-clean-config --force 02_PARAMS/ANGLE_INCIDENCE"
  echo ""
  echo "  # Avec adaptateur spÃ©cifique"
  echo "  export ADAPTATEUR=OF"
  echo "  cfd-clean-config 02_PARAMS/CONFIG_CUSTOM"
  echo ""
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#  ğŸ”§ ARGUMENT PARSING
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

POSITIONAL_ARGS=()
FORCE=false

while [[ $# -gt 0 ]]; do
  case "$1" in
    -h|--help)
      usage
      exit 0
      ;;
    -f|--force)
      FORCE=true
      shift
      ;;
    -*)
      _error "Unknown option: $1"
      echo "Use -h or --help for help" >&2
      exit 1
      ;;
    *)
      POSITIONAL_ARGS+=("$1")
      shift
      ;;
  esac
done

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Positional arguments validation
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

if [[ ${#POSITIONAL_ARGS[@]} -ne 1 ]]; then
  _error "Expected SOURCE_DIRECTORY"
  _error "Usage: $0 [options] <SOURCE_DIRECTORY>" >&2
  usage
  exit 1
fi

SOURCE_DIRECTORY="${POSITIONAL_ARGS[0]}"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#  ğŸ”Œ CHARGEMENT DE L'ADAPTATEUR
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ADAPTATEUR="${ADAPTATEUR:-OF}"
_info "Chargement de l'adaptateur: $ADAPTATEUR"

# Charger l'adaptateur (convention: essayer ${adaptateur}/adaptateur.sh puis ${adaptateur}.sh)
adaptateur_path="${CFD_FRAMEWORK}/adaptateurs/${ADAPTATEUR}/adaptateur.sh"
if [[ ! -f "$adaptateur_path" ]]; then
  adaptateur_path="${CFD_FRAMEWORK}/adaptateurs/${ADAPTATEUR}.sh"
fi

if [[ ! -f "$adaptateur_path" ]]; then
  _error "Adaptateur introuvable: $ADAPTATEUR"
  _error "Chemin recherchÃ©: $adaptateur_path"
  exit 1
fi

source "$adaptateur_path"

# VÃ©rifier l'installation de l'adaptateur
if ! adapt_verifier_installation; then
  _error "Ã‰chec de vÃ©rification de l'adaptateur $(adapt_nom)"
  exit 1
fi

_info "Adaptateur $(adapt_nom) chargÃ© et vÃ©rifiÃ©"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#  ğŸš€ LANCEMENT DU WRAPPER
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# 1. Lister les cas-tests dans 02_PARAMS/CONFIG/
declare -a LIST_CASE_TESTS_TO_MOVE=()

LIST_CASE_TESTS_TO_MOVE=($(find "$SOURCE_DIRECTORY" -maxdepth 1 -type d -name "$(adapt_nom)_V$(adapt_version)_*"))
_info "Liste des cas-tests Ã  supprimer dans $SOURCE_DIRECTORY"
for CASE_TEST in "${LIST_CASE_TESTS_TO_MOVE[@]}"; do
     _bullet "$CASE_TEST"
done

_info "Taille du rÃ©pertoire: $(util_obtenir_taille "$SOURCE_DIRECTORY")"
 
if [[ ! "${FORCE}" == true ]]; then
    confirmer "ÃŠtes-vous sÃ»r de vouloir supprimer ces cas-tests ?" o || exit 0
fi

separator_eq

TOTAL=${#LIST_CASE_TESTS_TO_MOVE[@]}
CURRENT=0

progres_init "Suppression des cas-tests" "$TOTAL"

for CASE_TEST in "${LIST_CASE_TESTS_TO_MOVE[@]}"; do
    ((CURRENT++))

    rm -rf "$CASE_TEST"

    progres_update "$CURRENT"
done

progres_done "TerminÃ©"

boite_result "Cas-tests supprimÃ©s"

_check "Taille du rÃ©pertoire: $(util_obtenir_taille "$SOURCE_DIRECTORY")"
_check "Liste des fichiers:"
ls -larth --color=always "$SOURCE_DIRECTORY"
echo 