#!/usr/bin/env bash
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#  cfd-exec â€” Applique cfd-post + cfd-move Ã  un cas-test depuis le BASE_DIR
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
#  Ce script permet d'appliquer cfd-post + cfd-move Ã  un cas-test depuis le BASE_DIR.
#  Il doit Ãªtre exÃ©cutÃ© dans le root de l'Ã©tude.
#
#  Usage: cfd-exec <LOCAL_CASE_PATH>
#
#  Arguments:
#    LOCAL_CASE_PATH     Chemin vers le cas-test Ã  post-traiter
#
#  Options:
#    -h, --help          Afficher l'aide
#    -f, --force         Forcer l'exÃ©cution mÃªme si POST_TRAITEMENT existe
#
#  Variables d'environnement requises:
#    CFD_FRAMEWORK       Chemin vers le framework CFD
#    CASE_NAME           Nom du cas-test
#    CASE_PATH           Chemin vers le cas-test source
#
#  Auteur : KL
#  Licence : MIT
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# VÃ©rifier que CFD_FRAMEWORK existe
if [[ ! -d "$CFD_FRAMEWORK" ]]; then
  echo "ERREUR: RÃ©pertoire CFD_FRAMEWORK introuvable: $CFD_FRAMEWORK" >&2
  exit 1
fi
source "${CFD_FRAMEWORK}/lib/format.sh"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 1. Fonction d'aide
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
usage() {
  cat <<EOF
Usage: cfd-exec <LOCAL_CASE_PATH>

Description:
  Applique cfd-post et cfd-move Ã  un cas-test depuis le rÃ©pertoire de base.
  Ce script doit Ãªtre exÃ©cutÃ© dans le root de l'Ã©tude.

Arguments:
  <LOCAL_CASE_PATH>       Chemin vers le cas-test Ã  post-traiter

Options:
  -h, --help              Afficher cette aide
  -f, --force             Forcer l'exÃ©cution mÃªme si POST_TRAITEMENT existe

Variables d'environnement requises:
  CFD_FRAMEWORK           Chemin vers le framework CFD
  CASE_NAME               Nom du cas-test
  CASE_PATH               Chemin vers le cas-test source

Exemples:
  cfd-exec /path/to/local/case
  cfd-exec ./02_PARAMS/Config01
  cfd-exec ./02_PARAMS/Config01 --force
EOF
  exit 0
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 2. Parsing des arguments
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
LOCAL_CASE_PATH=""
FORCE_MODE=false

while [[ $# -gt 0 ]]; do
  case "$1" in
    -h|--help)
      usage
      ;;
    -f|--force)
      FORCE_MODE=true
      shift
      ;;
    -*)
      die "Option inconnue: $1 (utilisez -h pour l'aide)"
      ;;
    *)
      if [[ -z "$LOCAL_CASE_PATH" ]]; then
        LOCAL_CASE_PATH="$1"
      else
        die "Trop d'arguments positionnels: $1"
      fi
      shift
      ;;
  esac
done

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 3. Validation et rÃ©solution des chemins
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Validation de l'argument obligatoire
if [[ -z "$LOCAL_CASE_PATH" ]]; then
  die "Argument manquant: <LOCAL_CASE_PATH> requis. Utilisez -h pour l'aide."
fi

# VÃ©rification de l'existence du rÃ©pertoire
if [[ ! -d "$LOCAL_CASE_PATH" ]]; then
  die "Le rÃ©pertoire n'existe pas: $LOCAL_CASE_PATH"
fi

# Validation des variables d'environnement requises
if [[ -z "${CASE_NAME:-}" ]]; then
  die "Variable d'environnement CASE_NAME non dÃ©finie"
fi

if [[ -z "${CASE_PATH:-}" ]]; then
  die "Variable d'environnement CASE_PATH non dÃ©finie"
fi

# Affichage des paramÃ¨tres validÃ©s
_result "Configuration validÃ©e"
kv "CFD_FRAMEWORK" "$CFD_FRAMEWORK"
kv "CASE_NAME" "$CASE_NAME"
kv "CASE_PATH" "$CASE_PATH"
kv "LOCAL_CASE_PATH" "$LOCAL_CASE_PATH"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 4. VÃ©rification de l'existence du post-traitement
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

POST_TRAITEMENT_DIR="$LOCAL_CASE_PATH/POST_TRAITEMENT"

if [[ -d "$POST_TRAITEMENT_DIR" ]]; then
  if [[ "$FORCE_MODE" == false ]]; then
    _warn "Le dossier POST_TRAITEMENT existe dÃ©jÃ  dans: $LOCAL_CASE_PATH"
    _info "Utilisez l'option -f ou --force pour forcer l'exÃ©cution."
    exit 0
  else
    _warn "Le dossier POST_TRAITEMENT existe dÃ©jÃ , mais mode --force activÃ©"
    _info "Poursuite de l'exÃ©cution..."
  fi
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#  ğŸš€ LANCEMENT
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

cd "$LOCAL_CASE_PATH" || die "Impossible de se dÃ©placer dans le cas-test: $LOCAL_CASE_PATH"

# --- Post-traitement --- #
${CFD_FRAMEWORK}/bin/cfd-post


# --- DÃ©placement des rÃ©sultats --- #
METADATA_YAML=".metadata.yaml"

if [[ ! -f "$METADATA_YAML" ]]; then
    die "Fichier $METADATA_YAML introuvable dans $(pwd)"
fi

CONFIG=$(yq -r ".configuration.nom" "$METADATA_YAML")

if [[ -z "$CONFIG" ]]; then
    die "Impossible d'extraire le nom de la configuration depuis le fichier $METADATA_YAML"
fi

DATA_DIR="$CASE_PATH/09_POST_TRAITEMENT/DATA/$CONFIG"

if [[ ! -d "$DATA_DIR" ]]; then
    mkdir -p "$DATA_DIR"
fi

${CFD_FRAMEWORK}/bin/cfd-move $DATA_DIR

cd "$CASE_PATH" || die "Impossible de se dÃ©placer dans le cas-test: $CASE_PATH"